{% extends 'base.html' %}
{% block title %}@{{ user }}'s {{ device.device_name }} Device Details{% endblock %}

{% block content %}
    <h1>@{{ user }}'s {{ device.device_name }} Device Details</h1>

    <div class="device-details">
        <ul>
            <li><strong>Device Name:</strong> {{ device.device_name }}</li>
            <li><strong>Operating System:</strong> {{ device.os_name }}</li>
            <li><strong>Software Count:</strong> {{ device.software.count }}</li>
            <li><strong>Vulnerability Count:</strong> {{ device.vulnerabilities.count }}</li>
            <!-- Add other device attributes here -->
        </ul>
    </div>

    <div class="filter-container">
        <div class="filter-column">
            <label class="filter-label">Filters:</label>
            <button type="button" onclick="applyFilters()">Apply Filters</button>
            <button type="button" onclick="resetFilters()">Reset Filters</button>
        </div>
        <div class="filter-column">
            <label for="softwareFilter" class="filter-label">Software:</label>
            <div id="softwareFilterOptions">
                <!-- Add options dynamically from available software, sorted alphabetically -->
                {% for software in device.software.all|dictsort:"name" %}
                    <input type="checkbox" name="softwareFilter" value="{{ software.name }}"> {{ software.name }}<br>
                {% endfor %}
            </div>
        </div>
        <div class="filter-column">
            <label for="cveScoreFilterMin" class="filter-label">Score Range:</label>
            <select id="cveScoreFilterMin">
                <!-- Hardcoded options for CVE Score range from 0 to 10 -->
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
            <select id="cveScoreFilterMax">
                <!-- Hardcoded options for CVE Score range from 0 to 10 -->
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10" selected>10</option>
            </select>
        </div>
    </div>

    <table id="deviceOrSoftwareTable">
        <thead>
            <tr>
                <th>Software Name</th>
                <th>CPE Name</th>
                <th>CVE ID</th>
                <th>CVE Score</th>
            </tr>
        </thead>
        <tbody>
            {% for software in device.software.all %}
                {% for vulnerability in software.vulnerabilities.all %}
                    <tr class="softwareRow" data-software="{{ software.name }}" data-date-added="{{ software.date_created|date:'Y' }}" data-cve-score="{{ vulnerability.cve_score }}">
                        <td>{{ software.name }}</td>
                        <td>{{ software.cpe_name }}</td>
                        <td><a href="{{ vulnerability.cve_url }}" target="_blank">{{ vulnerability.cve_id }}</a></td>
                        <td>{{ vulnerability.cve_score }}</td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination">
        <select id="resultsPerPage" onchange="updatePagination()">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="250">250</option>
        </select>
        <button id="prevPage" onclick="prevPage()">Previous</button>
        <button id="nextPage" onclick="nextPage()">Next</button>
    </div>

    <a id="backToTop" href="#">Back to Top</a>

    <script>
    var currentPage = 1;
    var resultsPerPage = 10;

    function applyFilters() {
        var softwareFilters = document.getElementsByName("softwareFilter");
        var selectedSoftware = [];

        // Loop through all checkboxes to find selected software
        for (var i = 0; i < softwareFilters.length; i++) {
            if (softwareFilters[i].checked) {
                selectedSoftware.push(softwareFilters[i].value);
            }
        }

        // Show/hide table rows based on selected software
        var table = document.getElementById("deviceOrSoftwareTable");
        var rows = table.rows;

        for (var i = 1; i < rows.length; i++) {
            var softwareName = rows[i].cells[0].innerText;

            // Check if the software name is included in the selected software array
            if (selectedSoftware.includes(softwareName)) {
                rows[i].style.display = "table-row";
            } else {
                rows[i].style.display = "none";
            }
        }

        // Update pagination after applying filters
        updatePagination();
    }

    function resetFilters() {
        var softwareFilters = document.getElementsByName("softwareFilter");
        for (var i = 0; i < softwareFilters.length; i++) {
            softwareFilters[i].checked = true;
        }

        // Apply filters after resetting
        applyFilters();
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Check all checkboxes when the DOM content is loaded
        var softwareFilters = document.getElementsByName("softwareFilter");
        for (var i = 0; i < softwareFilters.length; i++) {
            softwareFilters[i].checked = true;
        }

        // Initialize pagination
        updatePagination();
    });

    function updatePagination() {
        resultsPerPage = parseInt(document.getElementById("resultsPerPage").value);
        showPage(currentPage);
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            showPage(currentPage);
        }
    }

    function nextPage() {
        var totalPages = Math.ceil(document.getElementById("deviceOrSoftwareTable").rows.length / resultsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            showPage(currentPage);
        }
    }

    function showPage(page) {
        var table = document.getElementById("deviceOrSoftwareTable");
        var rows = table.rows;
        var startIndex = (page - 1) * resultsPerPage;
        var endIndex = startIndex + resultsPerPage;

        for (var i = 1; i < rows.length; i++) {
            if (i > startIndex && i <= endIndex) {
                rows[i].style.display = "table-row";
            } else {
                rows[i].style.display = "none";
            }
        }
    }

    // Script for smooth scrolling to top
    document.getElementById('backToTop').addEventListener('click', function(e) {
        e.preventDefault();
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
</script>



{% endblock %}
